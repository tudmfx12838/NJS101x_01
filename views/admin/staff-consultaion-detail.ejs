<%- include('../includes/head.ejs') %>

</head>

<body>
   <%- include('../includes/navigation.ejs') %>
    <main class="container">
        <div class="row mt-3">
            <div class="col-12 col-sm-7 col-lg-9"></div>
            <div class="col-12 col-sm-5 col-lg-3">
                <form action="/staffs/manage-timesheet/search/<%= staff._id %>?search=true" method="GET">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input class="form-control" type="text" id="search" name="search" placeholder="Nhập dữ liệu cần tìm">
                    <button class="btn btn-primary" type="submit">Tìm</button>
                </form>
            </div>
        </div>

        <div class="row mt-3">
            <div>
                <h4 class="card-title"><%= staff.name %></h4>
                <p class="card-text">Mã số: <%= staff.idNumber %></p>
                <p class="card-text">Tên nhân viên: <%= staff.name %></p>
                <p class="card-text">Phòng ban: <%= staff.department %></p>

                <button type="button" class="btn btn-primary mt-2 ml-1" data-bs-toggle="modal" data-bs-target="#myModal1">
                    Thêm giờ làm
                </button>
                <div id="myModal1" class="modal fade">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Đăng ký thông tin làm việc</h4>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form action="/staffs/manage-timesheet/add-timesheet/<%= staff._id %>?add=true" method="POST">
                                    <div class="mb-3 mt-3">
                                        <label for="location" class="form-label">Nơi làm việc: </label>
                                        <select class="form-select" name="location" id="location" value="company">
                                            <option value="Công Ty">Công Ty</option>
                                            <option value="Khách Hàng">Khách Hàng</option>
                                            <option value="Nhà">Nhà</option>
                                        </select>
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <label class="form-label" for="startTime">Thời bắt đầu: </label>
                                        <input class="form-control" type="datetime-local" name="startTime" id="startTime" value="">
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <label class="form-label" for="endTime">Thời kết thúc: </label>
                                        <input class="form-control" type="datetime-local" name="endTime" id="endTime" value="">
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <label class="form-label" for="leaveTime">Giờ nghỉ phép: </label>
                                        <input class="form-control" type="number" name="leaveTime" id="leaveTime" value="0">
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <div class="row">
                                            <div class="col">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <button class="btn btn-primary" type="submit">Thêm</button>
                                            </div>
                                            <div class="col">
                                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Hủy</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="row card">
            <ul class="list-group list-group-flush">
                <% if (timesheet) { %>
                    <% for (let timeSheetData of timesheet.timeSheetDatas) { %>
                        <li class="list-group-item">
                        <h1>Ngày: <%= timeSheetData.date %></h1>
                            <% for (let timeResult of timesheet.timeResults) { %>
                                <% const timeNow = timeResult.startTimes[0].startTime %>
                                <% const year = timeNow.getFullYear() %>
                                <% const month = (timeNow.getMonth()+1) < 10 ? ('0' + (timeNow.getMonth()+1)) : (timeNow.getMonth()+1) %>
                                <% const date = timeNow.getDate() < 10 ? ('0' + timeNow.getDate()) : timeNow.getDate() %>
                                <% const startTimeThisDate = `${year}-${month}-${date}` %>

                                <% if(timeSheetData.date == startTimeThisDate) { %> 
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">Địa điểm(giờ bắt đầu): 
                                            <% for (let i = 0; i < timeResult.startTimes.length; i++) { %>
                                                <%=  timeResult.locations[i].location + '('+ timeResult.startTimes[i].startTime.toTimeString().substring(0, 8) + '), ' %>
                                            <% } %>
                                        </li>
                                        <li class="list-group-item">
                                            Giờ kết thúc: <%= timeResult.endTime.toTimeString().substring(0, 8) %>
                                        </li>
                                    </ul>
                                <% } %>
                            <% } %>

                            <% var tlf_temp = 0 %>
                            <% for (let tlf of timesheet.takeLeaveInfo) { %>
                                <% if(timeSheetData.date == tlf.date) { %> 
                                    <% tlf_temp = tlf.leaveTime %>
                                <% } %>
                            <% } %>
                        <h5>Tổng thời gian đã làm: <%= (tlf_temp == 0) ? timeSheetData.timeTotal : (timeSheetData.timeTotal + tlf_temp*60)  %> phút</h5>
                        <h5>Thời  gian làm thiếu giờ: <%= (tlf_temp == 0) ? timeSheetData.incompleteTime : (timeSheetData.timeTotal + tlf_temp*60) > 480 ? 0 : timeSheetData.incompleteTime - (timeSheetData.timeTotal + tlf_temp*60)  %> phút</h5>
                        <h5>Thời gian làm thêm giờ: <%= (tlf_temp == 0) ? timeSheetData.overTime : (timeSheetData.timeTotal + tlf_temp*60) > 480 ? (timeSheetData.timeTotal + tlf_temp*60) - 480 : 0 %> phút</h5>
                        <h5>Số giờ nghỉ phép: <%= tlf_temp %> giờ</h5>
                        <h5>Trạng thái xác nhận: <%= timeSheetData.approveStatus === false ? 'Chưa Xác Nhận' : 'Đã Xác Nhận'%></h5>
                        
                        <% if (!timeSheetData.approveStatus) { %>
                            <form action="/staffs/manage-timesheet/approve/<%= staff._id %>?approve=true" method="POST">
                                <input type="hidden" name="thisDate" value="<%= timeSheetData.date %>">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button class="btn btn-primary mt-2 ml-1" type="submit">Xác nhận giờ làm</button>
                            </form>
    
                            <form action="/staffs/manage-timesheet/delete/<%= staff._id %>?delete=true" method="POST" >
                                <input type="hidden" name="thisDate" value="<%= timeSheetData.date %>">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button class="btn btn-danger mt-2 ml-1" type="submit">Xóa giờ làm</button>
                            </form>
                        <% } %>
                        </li>
                        <% } %>
                <% } else { %>
                    <h1>Chưa cập nhật thời gian làm việc</h1>
                <% } %>    
                
            </ul>
        </div>
        <br>
    </main>

<%- include('../includes/end.ejs') %>